name: Check Upstream Repository
on:
  workflow_dispatch:
    inputs:
      upstream_branch:
        description: 'Upstream repository branch name'
        required: false
        default: master
  schedule:
    - cron: '0 * * * *' # Runs every hour
jobs:
  check_upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up git config
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
      - name: Fetch upstream
        run: git fetch --depth 1 ${{ secrets.UPSTREAM_REPO_URL }} ${{ github.event.inputs.upstream_branch || 'master' }}:upstream
      - name: Get upstream commit ID
        id: get-upstream-commit
        run: echo "::set-output name=commit_id::$(git rev-parse upstream)"

      - name: Dispatch event if updates are found
        id: dispatch-event
        if: steps.get-upstream-commit.outputs.commit_id != steps.get-last-commit.outputs.last_commit_id
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: upstream_repository_updated
      - name: Update last known commit ID
        if: steps.dispatch-event.outcome == 'success'
        run: |
          git tag -f last_upstream_commit ${{ steps.get-upstream-commit.outputs.commit_id }}
          git push --force-with-lease origin last_upstream_commit

      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
            retain_days: 0
            keep_minimum_runs: 2
